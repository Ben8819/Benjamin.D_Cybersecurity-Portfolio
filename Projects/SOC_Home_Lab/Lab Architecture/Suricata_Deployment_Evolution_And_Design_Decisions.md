# Suricata Deployment Evolution and Design Decisions

## Overview

Suricata was first deployed directly on **pfSense** using the official Suricata package in order to quickly introduce network intrusion detection capabilities into the lab. This initial approach allowed for fast validation of IDS concepts, rule behavior, and alert visibility directly at the firewall level.

As the lab evolved and traffic volume, visibility requirements, and analysis goals increased, architectural limitations of an inline firewall-based IDS became apparent. This led to a second phase: migrating Suricata to a **dedicated IDS virtual machine** using **SPAN / mirrored traffic**, enabling more accurate detection, better performance isolation, and improved forensic capabilities.

This document describes that progression, the challenges encountered, and the reasoning behind the final design.

---

## Phase 1 – Suricata as a pfSense Package

### Initial Goals

The initial pfSense-based Suricata deployment aimed to:

- Validate IDS rule effectiveness in a controlled environment
- Observe real-time alerts generated by simulated attacks (e.g. port scans)
- Learn Suricata rule categories, priorities, and alert classifications
- Understand inline vs passive detection modes

Suricata was enabled on multiple interfaces, including:
- LAN
- SERVER_LAN

At this stage, blocking mode was initially disabled (IDS-only), then later tested using **Inline IPS mode**.

See below Screenshots:<br>
 [Inline_mode](Screenshots/Inline_mode.png)<br>
 [IDS_mode](Screenshots/IDS_mode.png)

---

### Interface-Level Monitoring

Suricata was configured per-interface directly in pfSense, allowing:

- Per-network visibility
- Independent rule application
- Interface-specific alert correlation

This setup made it possible to clearly observe how scans and suspicious traffic traversing internal segments triggered Suricata alerts in near real time.

---

### Attack Simulation and Detection

Using a Kali Linux host, multiple **Nmap SYN scans** were launched against an internal target:

- Service discovery attempts on common database ports
- VNC, PostgreSQL, MySQL, MSSQL, and Oracle SQL probes

Suricata successfully detected these activities and generated alerts such as:

- `ET SCAN Potential VNC Scan`
- `ET SCAN Suspicious inbound to PostgreSQL`
- `ET SCAN Suspicious inbound to MSSQL`
- `ET SCAN Suspicious inbound to MySQL`

Alerts were categorized as:
- *Attempted Information Leak*
- *Potentially Bad Traffic*

This confirmed correct rule loading, packet inspection, and classification behavior.

See below Screenshots:<br>
[Nmap_scan](Screenshots/Nmap_scan.png)<br>
[Alert_01](Screenshots/Alert_01.png)

---

### Limitations Encountered on pfSense

While functional, running Suricata directly on pfSense introduced several constraints:

#### Performance Coupling

- IDS processing competed with firewall, routing, and NAT tasks
- Inline IPS mode increased CPU load under scan conditions
- Packet drops became harder to distinguish from intentional blocking

#### Visibility Constraints

- Traffic inspection was limited to interfaces configured on pfSense
- East-west traffic visibility depended heavily on firewall placement
- Full packet capture and deeper forensic analysis were constrained

#### Operational Complexity

- Tuning rules directly on the firewall increased operational risk
- Troubleshooting false positives risked impacting production traffic
- Log management and long-term analysis were limited compared to a SIEM-backed workflow

These constraints made pfSense suitable for **learning and validation**, but suboptimal for a realistic SOC-style IDS architecture.

---
<br>

## Phase 2 – Migration to a Dedicated Suricata IDS

To align the lab with real-world SOC architectures, Suricata was migrated to a **dedicated IDS virtual machine** with the following goals:

- Decouple detection from enforcement
- Improve performance predictability
- Enable full passive inspection
- Integrate cleanly with centralized logging and SIEM tooling

---

### Traffic Duplication Architecture (pfSense Bridge-Based Monitoring)

Rather than relying on a physical or virtual switch SPAN feature, traffic duplication was implemented directly on **pfSense** using a **bridge-based architecture**.
Two internal interfaces were bridged on pfSense to allow normal traffic flow between network segments, while an additional dedicated interface was configured to forward duplicated packets to the IDS sensor.

---

### Architecture Overview

- **pfSense Bridge**
  - Bridges the monitored internal interfaces
  - Transparently forwards production traffic
  - Duplicates packets at the firewall level

- **IDS Monitoring Interface (e4)**
  - A dedicated pfSense interface connected to the IDS sensor
  - Receives duplicated traffic only
  - No routing or forwarding back into the network

- **srv-ids (Dedicated IDS VM)**
  - **Monitoring Interface (SPAN_NIC)**  
    - Receives duplicated traffic from pfSense  
    - Used exclusively by Suricata for packet inspection  
  - **Management Interface (Mgmt_NIC)**  
    - Connected to the SERVER_LAN switch  
    - Used for SSH access, log forwarding, updates, and administration  

This design cleanly separates **traffic inspection** from **management operations**, preventing monitoring traffic from interfering with administrative access or SIEM connectivity.

See below screenshot:<br>
[pfsense_bridges](Screenshots/pfsense_bridges.png)<br>

---

### Why Bridge-Based Duplication Was Chosen

This approach was selected due to limitations in the virtualized lab environment:

- No physical switch with native SPAN support
- Need for full packet visibility across multiple internal segments
- Desire to keep Suricata fully passive and non-intrusive

By duplicating traffic at the pfSense level, the IDS sensor gains visibility equivalent to a SPAN port while remaining independent from enforcement and routing logic.


### Benefits of This Design
 
#### Detection Accuracy

- East-west traffic between internal networks is fully observable.
- Reduced packet loss under scan or burst traffic
- More consistent alert timing
- Cleaner separation between benign noise and actionable alerts

#### Operational Safety

- Suricata analyzes traffic without introducing latency
- IDS tuning and rule refinement do not impact production traffic, no risk of blocking legitimate traffic during tuning
- Rule experimentation without firewall impact
- Safer alert suppression and refinement

#### Scalability and SIEM Integration

- Logs forwarded cleanly to Splunk
- Easier correlation with firewall, host, and authentication logs
- SOC-style workflows closer to enterprise environments where firewalls and IDS sensors are decoupled.
  
---

### Lessons Learned

This progression reflects a realistic security engineering journey:

- **pfSense Suricata package** is excellent for learning, validation, and small environments
- **Dedicated IDS with SPAN** is the correct architectural choice for:
  - Performance
  - Visibility
  - SOC operations
  - Forensic analysis
 
  While switch-based SPAN is common in enterprise environments, this bridge-based approach demonstrates how equivalent visibility can be achieved in constrained or virtualized labs.

The experience reinforced the importance of:
- Understanding packet flow at Layer 2 and Layer 3
- Separating detection from enforcement
- Designing monitoring paths that scale without increasing risk

---

### Conclusion

Deploying Suricata first on pfSense and later migrating to a dedicated IDS sensor mirrors real-world constraints and design evolution. The challenges encountered were not failures, but **signals to adapt the architecture**.

This iterative approach demonstrates:
- Practical IDS deployment experience
- Awareness of architectural trade-offs
- Ability to evolve designs based on operational feedback

The final setup provides a strong foundation for advanced detection, alert refinement, and SIEM-driven analysis.
